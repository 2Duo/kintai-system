{% extends 'base.html' %}
{% block title %}チャット{% endblock %}
{% block content %}
<h1>チャット - {{ partner_name }}</h1>
<div id="chat-box" class="chat-box mb-3">
  {% for m in messages %}
  <div class="chat-message {% if m['sender_id']==current_id %}self{% else %}other{% endif %}">
    <div class="chat-bubble {% if m['sender_id']==current_id %}self{% else %}other{% endif %}">
      {{ m['message'] }}
      <div class="text-muted small mt-1">{{ m['timestamp'] }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<form method="POST" id="chat-form" autocomplete="off">
  <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
  <div class="input-group">
    <input type="text" class="form-control" name="message" id="message-input" required>
    <button type="submit" class="btn btn-primary">送信</button>
  </div>
</form>
<script>
const box = document.getElementById('chat-box');
const currentId = {{ current_id }};
let last = '{{ messages[-1]["timestamp"] if messages else "" }}';
function appendMessage(m){
  const wrap = document.createElement('div');
  wrap.className = 'chat-message ' + (m.sender_id == currentId ? 'self' : 'other');
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble ' + (m.sender_id == currentId ? 'self' : 'other');
  bubble.textContent = m.message;
  const time = document.createElement('div');
  time.className = 'text-muted small mt-1';
  time.textContent = m.timestamp;
  bubble.appendChild(time);
  wrap.appendChild(bubble);
  box.appendChild(wrap);
  box.scrollTop = box.scrollHeight;
}
async function poll(){
  const resp = await fetch('{{ url_for('poll_chat', partner_id=partner_id) }}?after=' + encodeURIComponent(last));
  if(resp.ok){
    const data = await resp.json();
    data.messages.forEach(m => {
      appendMessage(m);
      if(Notification.permission === 'granted' && m.sender_id != {{ current_id }}){
        new Notification({{ partner_name|tojson }}, {body: m.message});
      }
      last = m.timestamp;
    });
  }
}
if('Notification' in window && Notification.permission === 'default'){
  Notification.requestPermission();
}
setInterval(poll, 5000);
</script>
{% endblock %}
